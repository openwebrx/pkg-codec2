From 7ca467bebd78e1681f20604d354a8d1469efe064 Mon Sep 17 00:00:00 2001
From: Mooneer Salem <mooneer@gmail.com>
Date: Fri, 17 Sep 2021 22:53:54 -0700
Subject: [PATCH 09/53] Bring in changes from mcdermj/codec2 to resolve build
 issue on Flex environment.

---
 src/fmfsk.c |  6 +++++-
 src/fsk.c   | 13 ++++++++-----
 2 files changed, 13 insertions(+), 6 deletions(-)

diff --git a/src/fmfsk.c b/src/fmfsk.c
index 0d244054..eefff834 100644
--- a/src/fmfsk.c
+++ b/src/fmfsk.c
@@ -116,9 +116,11 @@ void fmfsk_get_demod_stats(struct FMFSK *fmfsk,struct MODEM_STATS *stats){
     stats->rx_timing = fmfsk->stats->rx_timing;
     stats->foff = fmfsk->stats->foff;
 
+#ifndef __EMBEDDED__
     stats->neyesamp = fmfsk->stats->neyesamp;
     stats->neyetr = fmfsk->stats->neyetr;
     memcpy(stats->rx_eye, fmfsk->stats->rx_eye, sizeof(stats->rx_eye));
+#endif // !__EMBEDDED__
 
     /* these fields not used for FSK so set to something sensible */
 
@@ -340,6 +342,7 @@ void fmfsk_demod(struct FMFSK *fmfsk, uint8_t rx_bits[],float fmfsk_in[]){
         fmfsk->snr_mean = 0.9 * fmfsk->snr_mean + 0.1 * (10.0 * log10f(var_signal / var_noise));
     fmfsk->stats->snr_est = fmfsk->snr_mean;
 
+#ifndef __EMBEDDED__
     /* Collect an eye diagram */
     /* Take a sample for the eye diagrams */
     neyesamp = fmfsk->stats->neyesamp = Ts*4;
@@ -361,7 +364,8 @@ void fmfsk_demod(struct FMFSK *fmfsk, uint8_t rx_bits[],float fmfsk_in[]){
     for(i=0; i<fmfsk->stats->neyetr; i++)
         for(j=0; j<neyesamp; j++)
             fmfsk->stats->rx_eye[i][j] = (fmfsk->stats->rx_eye[i][j]/(2*eye_max))+.5;
-    
+#endif // !__EMBEDDED__
+ 
     modem_probe_samp_f("t_norm_rx_timing",&norm_rx_timing,1);
     modem_probe_samp_f("t_rx_filt",rx_filt,(nsym+1)*Ts);
 }
diff --git a/src/fsk.c b/src/fsk.c
index 1e699263..6a48b449 100644
--- a/src/fsk.c
+++ b/src/fsk.c
@@ -878,7 +878,7 @@ void fsk_demod_core(struct FSK *fsk, uint8_t rx_bits[], float rx_filt[], COMP fs
     /* due to oversample rate P, we have too many samples for eye
        trace.  So lets output a decimated version.  We use 2P
        as we want two symbols worth of samples in trace  */
-
+#ifndef __EMBEDDED__
     int neyesamp_dec = ceil(((float)P*2)/MODEM_STATS_EYE_IND_MAX);
     neyesamp = (P*2)/neyesamp_dec;
     assert(neyesamp <= MODEM_STATS_EYE_IND_MAX);
@@ -926,7 +926,8 @@ void fsk_demod_core(struct FSK *fsk, uint8_t rx_bits[], float rx_filt[], COMP fs
 
     for(i=0; i<M; i++)
         fsk->stats->f_est[i] = f_est[i];
-    
+#endif // !__EMBEDDED__
+ 
     /* Dump some internal samples */
     modem_probe_samp_f("t_EbNodB",&(fsk->EbNodB),1);
     modem_probe_samp_f("t_ppm",&(fsk->ppm),1);
@@ -967,7 +968,7 @@ static void stats_init(struct FSK *fsk) {
     /* asserts below as we found some problems over-running eye matrix */
     
     /* TODO: refactor eye tracing code here and in fsk_demod */
-    
+#ifndef __EMBEDDED__    
     int neyesamp_dec = ceil(((float)P*2)/MODEM_STATS_EYE_IND_MAX);
     int neyesamp = (P*2)/neyesamp_dec;
     assert(neyesamp <= MODEM_STATS_EYE_IND_MAX);
@@ -984,6 +985,7 @@ static void stats_init(struct FSK *fsk) {
            }
         }
     }
+#endif // !__EMBEDDED__
 
     fsk->stats->rx_timing = fsk->stats->snr_est = 0;
     
@@ -1017,12 +1019,13 @@ void fsk_get_demod_stats(struct FSK *fsk, struct MODEM_STATS *stats){
     stats->snr_est = fsk->stats->snr_est;           // TODO: make this SNR not Eb/No
     stats->rx_timing = fsk->stats->rx_timing;
     stats->foff = fsk->stats->foff;
-
+#ifndef __EMBEDDED__
     stats->neyesamp = fsk->stats->neyesamp;
     stats->neyetr = fsk->stats->neyetr;
     memcpy(stats->rx_eye, fsk->stats->rx_eye, sizeof(stats->rx_eye));
     memcpy(stats->f_est, fsk->stats->f_est, fsk->mode*sizeof(float));
-        
+#endif // !__EMBEDDED__
+ 
     /* these fields not used for FSK so set to something sensible */
 
     stats->sync = 0;
-- 
2.30.2

