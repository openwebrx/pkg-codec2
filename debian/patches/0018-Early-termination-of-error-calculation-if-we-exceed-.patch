From 5bd6fd460afbbb3460ca107456811cde4b4f2d4c Mon Sep 17 00:00:00 2001
From: Mooneer Salem <mooneer@gmail.com>
Date: Sun, 17 Oct 2021 14:45:23 -0700
Subject: [PATCH 18/53] Early termination of error calculation if we exceed the
 maximum in the list.

---
 src/mbest.c | 17 ++++++++---------
 1 file changed, 8 insertions(+), 9 deletions(-)

diff --git a/src/mbest.c b/src/mbest.c
index 0baea845..6f9190d1 100644
--- a/src/mbest.c
+++ b/src/mbest.c
@@ -122,21 +122,20 @@ void mbest_search(
 )
 {
    float   e;
-   int     j;
 
-   for(j=0; j<m; j++) {
+   for(int j=0; j<m; j++) {
         float   diff;
         int i;
 
-	e = 0.0;
-	for(i=0; i<k; i++) {
-	    diff = cb[j*k+i]-vec[i];
-	    e += diff*w[i]*diff*w[i];
-	}
+        e = 0.0;
+        for(int i = 0; i < k && e < mbest->list[mbest->entries - 1].error; i++) {
+            diff = cb[j*k+i]-vec[i];
+            e += diff*w[i]*diff*w[i];
+        }
 
-	index[0] = j;
+        index[0] = j;
         if (e < mbest->list[mbest->entries - 1].error)
-	    mbest_insert(mbest, index, e);
+            mbest_insert(mbest, index, e);
    }
 }
 
-- 
2.30.2

